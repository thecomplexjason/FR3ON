-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- جدول نخزن فيه الـ ESP
local espGuis = {}
local activeSelections = {}
local itemESPConnection

-- GUI
local playerGui = player:WaitForChild("PlayerGui")
local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.Name = "ESP_Dropdown"

-- زرار رئيسي
local mainButton = Instance.new("TextButton")
mainButton.Size = UDim2.new(0, 120, 0, 40)
mainButton.Position = UDim2.new(0, 20, 0, 200)
mainButton.BackgroundColor3 = Color3.fromRGB(50, 50, 200)
mainButton.TextColor3 = Color3.fromRGB(255, 255, 255)
mainButton.Text = "ESP Menu"
mainButton.Parent = screenGui

-- OK Button
local okButton = Instance.new("TextButton")
okButton.Size = UDim2.new(0, 120, 0, 40)
okButton.Position = UDim2.new(0, 150, 0, 200)
okButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
okButton.TextColor3 = Color3.fromRGB(255, 255, 255)
okButton.Text = "OK"
okButton.Parent = screenGui

-- Stop Button
local stopButton = Instance.new("TextButton")
stopButton.Size = UDim2.new(0, 120, 0, 40)
stopButton.Position = UDim2.new(0, 280, 0, 200)
stopButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
stopButton.TextColor3 = Color3.fromRGB(255, 255, 255)
stopButton.Text = "Stop ESP"
stopButton.Parent = screenGui

-- Dropdown Frame
local dropdown = Instance.new("ScrollingFrame")
dropdown.Size = UDim2.new(0, 200, 0, 350)
dropdown.Position = UDim2.new(0, 20, 0, 250)
dropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
dropdown.Visible = false
dropdown.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdown.ScrollBarThickness = 8
dropdown.Parent = screenGui

-- أقسام
local sections = {
    ["الحديد"] = {
        "Gem of the Forest Fragment","Gem of the Forest","Cultist Gem","UFO Junk","UFO Component","UFO Scrap",
        "Old Car Engine","Washing Machine","Broken Microwave","Broken Fan","Old Radio","Sheet Metal","Tyre","Bolt"
    },
    ["الوقود"] = {
        "Log","Sapling","Coal","Fuel Canister","Oil Barrel"
    },
    ["الادوات"] = {
        "Revolver","Rifle","Tactical Shotgun","Revolver Ammo","Rifle Ammo","Alien Armour","Leather Body","Iron Body","Thorn Body","Riot Shield",
        "Old Flashlight","Strong Flashlight","Morningstar","Laser Sword","Raygun","Chainsaw","Strong Axe","Good Axe","Giant Sack","Good Sack","Spear"
    },
    ["الطعام"] = {
        "Carrot","Berry","Morsel","Steak","Cooked Morsel","Cooked Steak","Ribs","Cooked Ribs"
    },
    ["اخر"] = {
        "Bunny Foot","Wolf Pelt","Alpha Wold Pelt","Bear Pelt","Arctic Fox Pelt","Polar Bear Pelt","Mammoth Tusk","Seed Box","Bandage","Medkit"
    }
}

-- إنشاء عناوين + أزرار
local yPos = 0
for sectionName, items in pairs(sections) do
    -- عنوان القسم
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Position = UDim2.new(0, 0, 0, yPos)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 255, 0)
    title.Text = sectionName
    title.Font = Enum.Font.SourceSansBold
    title.TextScaled = true
    title.Parent = dropdown

    yPos = yPos + 30

    -- أزرار العناصر
    for _, itemName in ipairs(items) do
        local option = Instance.new("TextButton")
        option.Size = UDim2.new(1, 0, 0, 30)
        option.Position = UDim2.new(0, 0, 0, yPos)
        option.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
        option.TextColor3 = Color3.fromRGB(255, 255, 255)
        option.Text = itemName
        option.TextScaled = false -- 🔹 إلغاء التكبير التلقائي
        option.TextSize = 14      -- 🔹 تصغير حجم الخط
        option.Parent = dropdown

        -- علامة التحديد
        local selectedIndicator = Instance.new("Frame")
        selectedIndicator.Size = UDim2.new(0, 5, 1, 0)
        selectedIndicator.Position = UDim2.new(0, 0, 0, 0)
        selectedIndicator.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        selectedIndicator.Visible = false
        selectedIndicator.Parent = option

        option.MouseButton1Click:Connect(function()
            if activeSelections[itemName] then
                activeSelections[itemName] = nil
                selectedIndicator.Visible = false
            else
                activeSelections[itemName] = true
                selectedIndicator.Visible = true
            end
        end)

        yPos = yPos + 30
    end
end

dropdown.CanvasSize = UDim2.new(0, 0, 0, yPos)

-- فتح/إغلاق الـ Dropdown
mainButton.MouseButton1Click:Connect(function()
    dropdown.Visible = not dropdown.Visible
end)

-- وظيفة ESP
local function createESP(itemModel)
    local adornee = itemModel:FindFirstChildWhichIsA("BasePart")
    if not adornee then return end

    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Size = UDim2.new(0, 150, 0, 30)
    billboardGui.Adornee = adornee
    billboardGui.AlwaysOnTop = true
    billboardGui.ExtentsOffsetWorldSpace = Vector3.new(0, 2, 0)
    billboardGui.Parent = adornee

    local label = Instance.new("TextLabel", billboardGui)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = itemModel.Name .. "\n AZC Hub - FR3ON"
    label.Font = Enum.Font.SourceSansBold
    label.TextColor3 = Color3.fromRGB(255, 0, 0)
    label.TextScaled = true
    label.TextStrokeTransparency = 0.5
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)

    espGuis[itemModel] = billboardGui
end

-- زر OK
okButton.MouseButton1Click:Connect(function()
    if next(activeSelections) == nil then
        warn("لم يتم اختيار أي عنصر!")
        return
    end

    if itemESPConnection then
        itemESPConnection:Disconnect()
        itemESPConnection = nil
    end

    itemESPConnection = RunService.RenderStepped:Connect(function()
        local itemsFolder = Workspace:FindFirstChild("Items")
        if not itemsFolder then return end

        for _, itemModel in pairs(itemsFolder:GetChildren()) do
            if itemModel:IsA("Model") and activeSelections[itemModel.Name] then
                if not espGuis[itemModel] then
                    -- تحقق المسافة بين الموديلات
                    local skip = false
                    for otherModel, _ in pairs(espGuis) do
                        if otherModel.PrimaryPart and itemModel.PrimaryPart then
                            local dist = (otherModel.PrimaryPart.Position - itemModel.PrimaryPart.Position).Magnitude
                            if dist < 15 then
                                skip = true
                                break
                            end
                        end
                    end

                    if not skip then
                        createESP(itemModel)
                    end
                end
            end
        end
    end)

    print("تم عمل ESP بنجاح")
end)

-- زر Stop
stopButton.MouseButton1Click:Connect(function()
    if itemESPConnection then
        itemESPConnection:Disconnect()
        itemESPConnection = nil
    end
    for model, gui in pairs(espGuis) do
        if gui then gui:Destroy() end
    end
    espGuis = {}
    print("تم إيقاف ESP")
end)
